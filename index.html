<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8" />
 <title>Alquimi¬∑k ¬∑ Tester</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

 <style>
  :root {
   --bg: #0f0f0f;
   --panel: #181818;
   --user-bubble: #2a3a2a;
   --user-text: #81ff9c;
   --agent-bubble: #1f1f1f;
   --agent-text: #e0e0e0;
   --muted: rgba(255,255,255,0.4);
  }

  * { box-sizing: border-box; }

  html, body {
   margin: 0;
   padding: 0;
   height: 100%;
   background: var(--bg);
   color: #fff;
   font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  }

  body {
   display: grid;
   grid-template-rows: auto 1fr auto;
   height: 100dvh;
  }

  /* ---------- HEADER ---------- */
  header {
   background: var(--panel);
   padding: 10px 16px;
   display: flex;
   align-items: center;
   justify-content: space-between;
   border-bottom: 1px solid #333;
  }

  header span {
   font-weight: 700;
   font-size: 16px;
   letter-spacing: 0.5px;
  }

  select {
   background: #2a2a2a;
   color: #fff;
   border: 1px solid #444;
   border-radius: 6px;
   padding: 6px 10px;
   font-size: 14px;
   outline: none;
  }

  /* ---------- CHAT ---------- */
  #chat-wrapper {
   overflow-y: auto;
   display: flex;
   justify-content: center;
   padding: 0 0 20px 0;
  }

  #chat {
   width: 100%;
   max-width: 800px;
   padding: 20px 16px;
   display: flex;
   flex-direction: column;
   gap: 18px;
  }

  .msg {
   display: flex;
   flex-direction: column;
   max-width: 85%;
  }

  .msg.user {
   align-self: flex-end;
   align-items: flex-end;
  }

  .msg.agent {
   align-self: flex-start;
   align-items: flex-start;
  }

  .label {
   font-size: 11px;
   font-weight: 600;
   margin-bottom: 4px;
   color: var(--muted);
   display: flex;
   align-items: center;
   gap: 6px;
  }

  /* Punto de color identificativo */
  .dot {
   width: 8px;
   height: 8px;
   border-radius: 50%;
   background: #666;
  }
  .agent .dot { background: #9b59b6; /* Morado Alquimik */ }
  .user .dot { background: #2ecc71; /* Verde Usuario */ }

  .bubble {
   padding: 12px 16px;
   border-radius: 12px;
   line-height: 1.5;
   font-size: 15px;
   white-space: pre-wrap; /* Respeta saltos de l√≠nea */
   box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  }

  .user .bubble {
   background: var(--user-bubble);
   color: var(--user-text);
   border-bottom-right-radius: 2px;
  }

  .agent .bubble {
   background: var(--agent-bubble);
   color: var(--agent-text);
   border-bottom-left-radius: 2px;
   border: 1px solid #333;
  }

  .meta {
   font-size: 10px;
   color: var(--muted);
   margin-top: 4px;
   opacity: 0.7;
  }

  /* ---------- INPUT ---------- */
  footer {
   background: var(--panel);
   padding: 12px;
   display: flex;
   justify-content: center;
   border-top: 1px solid #333;
  }

  .input-wrapper {
   width: 100%;
   max-width: 800px;
   display: flex;
   gap: 10px;
   align-items: flex-end;
  }

  textarea {
   flex: 1;
   background: #222;
   color: #fff;
   resize: none;
   border-radius: 12px;
   border: 1px solid #444;
   padding: 12px;
   font-size: 15px;
   min-height: 48px;
   max-height: 150px;
   outline: none;
  }

  textarea:focus {
   border-color: #666;
  }

  button {
   background: #333;
   color: #fff;
   border: 1px solid #555;
   border-radius: 12px;
   padding: 0 20px;
   height: 48px;
   font-weight: 600;
   font-size: 14px;
   cursor: pointer;
   transition: background 0.2s;
  }

  button:hover {
   background: #444;
  }
 </style>
</head>

<body>

<header>
 <span>üèõÔ∏è ALQUIMI¬∑K</span>
 <select id="agentSelect"></select>
</header>

<div id="chat-wrapper">
 <div id="chat"></div>
</div>

<footer>
 <div class="input-wrapper">
  <textarea id="message" placeholder="Habla con el sistema..."></textarea>
  <button onclick="sendMessage()">Enviar</button>
 </div>
</footer>

<script>
 const AGENTS = {
  hildegard: "Hildegard (Cuerpo)",
  lyra: "Lyra (Tiempo)",
  maya: "Maya (Espacio)",
  matt_natalia: "Matt ¬∑ Natalia (Vibraci√≥n)",
  chloe: "Chlo√´ (Arquitectura)"
 };

 const agentSelect = document.getElementById("agentSelect");
 
 Object.entries(AGENTS).forEach(([key, name]) => {
  const opt = document.createElement("option");
  opt.value = key;
  opt.textContent = name;
  agentSelect.appendChild(opt);
 });

 const chatWrapper = document.getElementById("chat-wrapper");
 const chat = document.getElementById("chat");
 const textarea = document.getElementById("message");

 function nowTime() {
  return new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
 }

 function scrollToBottom() {
  requestAnimationFrame(() => {
   chatWrapper.scrollTop = chatWrapper.scrollHeight;
  });
 }

 function autoResizeTextarea() {
  textarea.style.height = "auto";
  textarea.style.height = Math.min(textarea.scrollHeight, 150) + "px";
 }

 textarea.addEventListener("input", autoResizeTextarea);
 
 // Enviar con Enter (sin Shift)
 textarea.addEventListener("keydown", (e) => {
   if (e.key === "Enter" && !e.shiftKey) {
     e.preventDefault();
     sendMessage();
   }
 });

 function addMessage({ text, sender, agentKey }) {
  const isUser = sender === "user";
  const name = isUser ? "Diana (Tester)" : AGENTS[agentKey];
  
  const html = `
   <div class="msg ${sender}">
    <div class="label">
      <div class="dot"></div> ${name}
    </div>
    <div class="bubble">${text}</div>
    <div class="meta">${nowTime()}</div>
   </div>
  `;
  
  chat.insertAdjacentHTML("beforeend", html);
  scrollToBottom();
 }

 async function sendMessage() {
  const text = textarea.value.trim();
  if (!text) return;

  const agentKey = agentSelect.value;
  textarea.value = "";
  autoResizeTextarea();

  addMessage({ text, sender: "user" });

  try {
   const response = await fetch(
    "https://alquimik-backend.onrender.com/api/chat",
    {
     method: "POST",
     headers: { "Content-Type": "application/json" },
     body: JSON.stringify({ mensaje: text, to: agentKey })
    }
   );

   const data = await response.json();

   addMessage({
    text: data.mensaje || "‚ö†Ô∏è Respuesta vac√≠a del servidor",
    sender: "agent",
    agentKey
   });

  } catch (err) {
   addMessage({
    text: "‚ö†Ô∏è Error de conexi√≥n con el Backend.",
    sender: "agent",
    agentKey
   });
  }
 }
</script>

</body>
</html>
