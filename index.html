<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8" />
 <title>Alquimi¬∑k ¬∑ Tester</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
 <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

 <style>
  :root {
   --bg: #0a0a0a;
   --panel: #161616;
   --accent: #9b59b6;
   --user-bubble: #1e3a2a;
   --user-text: #e0f2f1;
   --agent-bubble: #222;
   --agent-text: #e0e0e0;
   --muted: rgba(255,255,255,0.4);
  }

  * { box-sizing: border-box; }
  body { margin: 0; padding: 0; height: 100dvh; background: var(--bg); color: #fff; font-family: sans-serif; display: grid; grid-template-rows: auto 1fr auto; }

  /* HEADER */
  header { background: var(--panel); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #333; }
  header span { font-weight: 700; letter-spacing: 1px; color: var(--accent); }
  select { background: #333; color: #fff; border: none; padding: 6px; border-radius: 4px; }

  /* CHAT */
  #chat-wrapper { overflow-y: auto; display: flex; justify-content: center; padding: 20px 0; }
  #chat { width: 100%; max-width: 800px; padding: 0 20px; display: flex; flex-direction: column; gap: 20px; }

  .msg { display: flex; flex-direction: column; max-width: 85%; }
  .msg.user { align-self: flex-end; align-items: flex-end; }
  .msg.agent { align-self: flex-start; align-items: flex-start; }

  .label { font-size: 11px; margin-bottom: 4px; color: var(--muted); display: flex; align-items: center; gap: 6px; text-transform: uppercase; }
  .dot { width: 6px; height: 6px; border-radius: 50%; }
  .agent .dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
  .user .dot { background: #2ecc71; }

  .bubble { padding: 14px 18px; border-radius: 12px; line-height: 1.6; font-size: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
  .user .bubble { background: var(--user-bubble); color: var(--user-text); border-bottom-right-radius: 2px; }
  .agent .bubble { background: var(--agent-bubble); color: var(--agent-text); border-bottom-left-radius: 2px; border: 1px solid #333; min-height: 40px; }

  /* Markdown Styles */
  .bubble p { margin: 0 0 10px; } .bubble p:last-child { margin: 0; }
  .bubble strong { color: #fff; } 
  .bubble ul { margin: 5px 0 10px 20px; padding: 0; }

  /* LOADER ANIMADO */
  #loader { display: none; align-items: center; gap: 10px; padding: 0 20px; color: var(--muted); font-size: 12px; font-style: italic; }
  .pulse-ring { width: 20px; height: 20px; border: 2px solid var(--accent); border-radius: 50%; position: relative; animation: pulse 1.5s infinite; }
  .pulse-core { width: 6px; height: 6px; background: var(--accent); position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%) rotate(45deg); }
  @keyframes pulse { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }

  /* INPUT */
  footer { background: var(--panel); padding: 16px; display: flex; justify-content: center; border-top: 1px solid #333; }
  .input-wrapper { width: 100%; max-width: 800px; display: flex; gap: 10px; background: #222; padding: 8px; border-radius: 16px; border: 1px solid #444; }
  textarea { flex: 1; background: transparent; color: #fff; border: none; padding: 10px; resize: none; font-size: 15px; outline: none; max-height: 150px; }
  button { background: var(--accent); color: #fff; border: none; border-radius: 10px; padding: 0 20px; font-weight: 600; cursor: pointer; }
 </style>
</head>
<body>

<header>
 <span>üèõÔ∏è ALQUIMI¬∑K</span>
 <select id="agentSelect"></select>
</header>

<div id="chat-wrapper">
 <div id="chat"></div>
</div>

<div id="loader">
 <div class="pulse-ring"><div class="pulse-core"></div></div>
 <span>Consultando el Concilio...</span>
</div>

<footer>
 <div class="input-wrapper">
  <textarea id="message" placeholder="Escribe aqu√≠..."></textarea>
  <button onclick="sendMessage()">Enviar</button>
 </div>
</footer>

<script>
 const AGENTS = { hildegard: "Hildegard", lyra: "Lyra", maya: "Maya", matt_natalia: "Matt", chloe: "Chlo√´" };
 const agentSelect = document.getElementById("agentSelect");
 Object.entries(AGENTS).forEach(([k,n]) => {
  const o = document.createElement("option"); o.value = k; o.textContent = n; agentSelect.appendChild(o);
 });

 const chatWrapper = document.getElementById("chat-wrapper");
 const chat = document.getElementById("chat");
 const loader = document.getElementById("loader");
 const textarea = document.getElementById("message");

 function now() { return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
 function scroll() { requestAnimationFrame(() => chatWrapper.scrollTop = chatWrapper.scrollHeight); }

 textarea.addEventListener("keydown", (e) => {
   if(e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
 });

 // EFECTO DE ESCRITURA (TYPING)
 function typeText(element, text) {
   let i = 0;
   // Renderizamos Markdown primero, pero lo escribimos sucio? No, mejor escribir texto y luego parsear.
   // Truco: Escribimos el HTML final poco a poco.
   const html = marked.parse(text);
   // Para simplificar el efecto typing con HTML, lo mostramos de golpe con fade-in,
   // o simulamos escritura rapida.
   // Opci√≥n A: Escritura simple
   element.innerHTML = html; 
   // Opci√≥n B: Si quieres ver letra a letra, requiere l√≥gica compleja para no romper tags HTML.
   // Usaremos un FADE IN suave que es m√°s elegante.
   element.style.opacity = 0;
   element.style.transition = "opacity 0.5s";
   requestAnimationFrame(() => element.style.opacity = 1);
 }

 function addMessage({ text, sender, agentKey }) {
  const name = sender === "user" ? "T√∫" : AGENTS[agentKey];
  const div = document.createElement("div");
  div.className = `msg ${sender}`;
  
  let content = "";
  if (sender === "user") {
    content = text;
  } else {
    content = marked.parse(text); // Convertir Markdown
  }

  div.innerHTML = `
   <div class="label"><div class="dot"></div> ${name}</div>
   <div class="bubble">${content}</div>
   <div class="meta">${now()}</div>
  `;
  
  chat.appendChild(div);
  scroll();
 }

 async function sendMessage() {
  const text = textarea.value.trim();
  if(!text) return;
  textarea.value = "";
  
  addMessage({ text, sender: "user" });
  
  loader.style.display = "flex"; // Mostrar Rombo
  chat.appendChild(loader); // Mover loader al final
  scroll();

  try {
   const res = await fetch("https://alquimik-backend.onrender.com/api/chat", {
    method: "POST", headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ mensaje: text, to: agentSelect.value })
   });
   const data = await res.json();
   
   loader.style.display = "none";
   addMessage({ text: data.mensaje || "...", sender: "agent", agentKey: agentSelect.value });

  } catch(e) {
   loader.style.display = "none";
   addMessage({ text: "Error de conexi√≥n", sender: "agent", agentKey: agentSelect.value });
  }
 }
</script>
</body>
</html>
